<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Opus Platform API – Developer Documentation</title>
<style>
body {
  font-family: Menlo, Monaco, Consolas, monospace;
  margin: 40px;
  max-width: 1100px;
  background: #ffffff;
  color: #111;
}
h1, h2, h3 {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  margin-top: 40px;
}
pre {
  background: #f6f8fa;
  padding: 16px;
  border-radius: 6px;
  overflow-x: auto;
}
code {
  background: #f0f0f0;
  padding: 2px 6px;
  border-radius: 4px;
}
.endpoint {
  border-left: 4px solid #333;
  padding-left: 16px;
  margin-top: 30px;
}
.warning {
  background: #fff3cd;
  padding: 12px;
  border-left: 4px solid #856404;
}
.section {
  margin-bottom: 50px;
}
table {
  border-collapse: collapse;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
}
</style>
</head>
<body>

<h1>Opus Platform API – Developer Documentation</h1>

<div class="section">
<h2>Purpose</h2>
<p>
Internal API layer for style class categorization and weight management. This API:
</p>
<ul>
  <li>Abstracts database access to Supabase Postgres</li>
  <li>Enforces validation (class codes, weight totals, request shape)</li>
  <li>Provides an integration-ready “playback profile” payload for Opus queue-building</li>
</ul>
</div>

<div class="section">
<h2>Runtime Architecture</h2>
<pre>
Browser (Opus Platform UI)
        ↓
Fastify API (Node) on Render
        ↓
Supabase Postgres (sandbox tables for POC)
</pre>
<p>
This API is internal-use and protected by an internal header key. It is not intended to be publicly exposed.
</p>
</div>

<div class="section">
<h2>Authentication Model</h2>
<div class="warning">
<p><strong>All non-health endpoints require an internal key header.</strong></p>
</div>

<p>
Requests must include the header <code>X-Internal-Key</code> matching the server environment variable <code>OPUS_INTERNAL_API_KEY</code>.
</p>

<h3>Example (curl)</h3>
<pre>
curl -H "X-Internal-Key: &lt;OPUS_INTERNAL_API_KEY&gt;" \
  https://&lt;your-render-service&gt;/v1/styles
</pre>

<h3>Example (fetch)</h3>
<pre>
fetch(url, {
  method: "GET",
  headers: {
    "X-Internal-Key": internalKey
  }
})
</pre>
</div>

<div class="section">
<h2>Authorization</h2>
<p>
Authorization is currently coarse-grained: possession of <code>X-Internal-Key</code> grants access.
This is acceptable for the POC, and intended to move behind Opus employee authentication later.
</p>

<table>
<tr>
<th>Operation</th>
<th>Allowed</th>
</tr>
<tr>
<td>Read styles/tracks/assignments/weights/playback-profile</td>
<td>Internal key required</td>
</tr>
<tr>
<td>Write assignments/weights</td>
<td>Internal key required</td>
</tr>
</table>
</div>

<div class="section">
<h2>Versioning</h2>
<pre>/v1</pre>

<ul>
<li>Breaking changes → new version path</li>
<li>Additive changes allowed within same version</li>
</ul>
</div>

<div class="section">
<h2>Database Schema (Relevant Tables)</h2>

<h3>sim_styles</h3>
<pre>
id (UUID, PK)
name (TEXT)
</pre>

<h3>library_songs</h3>
<pre>
id (UUID, PK)
title (TEXT)
artist (TEXT)
album (TEXT)
peak_year (INT)
run_time_seconds (INT)
styles (TEXT)
</pre>

<h3>sim_style_songs</h3>
<pre>
style_id (UUID, FK → sim_styles.id)
library_song_id (UUID, FK → library_songs.id)
sim_duration_seconds (INT)
PRIMARY KEY (style_id, library_song_id)
</pre>

<h3>sim_style_song_classes</h3>
<pre>
style_id (UUID)
library_song_id (UUID)
class_code (TEXT)  // A | B | C | REST
moved_at (TIMESTAMP)
PRIMARY KEY (style_id, library_song_id)
</pre>

<h3>sim_style_class_weights</h3>
<pre>
style_id (UUID)
class_code (TEXT)  // A | B | C | REST (REST usually 0)
weight_pct (INT 0–100)
PRIMARY KEY (style_id, class_code)
</pre>
</div>

<div class="section">
<h2>Class Code Rules</h2>
<ul>
<li>Valid: <code>A</code>, <code>B</code>, <code>C</code>, <code>REST</code></li>
<li>Stored uppercase</li>
<li><strong>REST</strong> = explicitly not played</li>
<li><strong>UNCATEGORIZED</strong> = in the style but has no row in <code>sim_style_song_classes</code></li>
</ul>
</div>

<div class="section">
<h2>Endpoints</h2>

<div class="endpoint">
<h3>GET /health</h3>
<p>Health check. No auth required.</p>
<pre>
{ "ok": true }
</pre>
</div>

<div class="endpoint">
<h3>GET /v1/styles</h3>
<p>Returns all styles ordered by name.</p>
</div>

<div class="endpoint">
<h3>GET /v1/styles/{style_id}/tracks</h3>
<p>Returns style membership plus song metadata (joined from <code>library_songs</code>).</p>
<p>Response rows are normalized to include <code>song</code>.</p>
<pre>
{
  "data": [
    {
      "library_song_id": "uuid",
      "sim_duration_seconds": 215,
      "song": {
        "id": "uuid",
        "artist": "Artist",
        "title": "Title",
        "album": "Album",
        "peak_year": 2017,
        "run_time_seconds": 215,
        "styles": "..."
      }
    }
  ]
}
</pre>
</div>

<div class="endpoint">
<h3>GET /v1/styles/{style_id}/assignments</h3>
<p>Returns all explicit class assignments for a style.</p>
<pre>
{
  "data": [
    { "library_song_id": "uuid", "class_code": "A", "moved_at": "2026-02-20T18:00:00Z" }
  ]
}
</pre>
</div>

<div class="endpoint">
<h3>PUT /v1/styles/{style_id}/assignments</h3>
<p>Bulk upsert assignments (conflict target: <code>(style_id, library_song_id)</code>).</p>
<pre>
{
  "assignments": [
    { "library_song_id": "uuid", "class_code": "A" }
  ]
}
</pre>
<p>Notes:</p>
<ul>
  <li>Class codes are normalized to uppercase</li>
  <li>Valid codes: A/B/C/REST</li>
</ul>
</div>

<div class="endpoint">
<h3>DELETE /v1/styles/{style_id}/assignments</h3>
<p>Bulk delete assignments (returns songs to Uncategorized).</p>
<pre>
{
  "songIds": ["uuid1", "uuid2"]
}
</pre>
</div>

<div class="endpoint">
<h3>GET /v1/styles/{style_id}/weights</h3>
<p>Returns class weights for a style.</p>
<pre>
{
  "data": [
    { "class_code": "A", "weight_pct": 35 },
    { "class_code": "B", "weight_pct": 35 },
    { "class_code": "C", "weight_pct": 30 }
  ]
}
</pre>
</div>

<div class="endpoint">
<h3>PUT /v1/styles/{style_id}/weights</h3>
<p>Upserts weights for A/B/C (and optionally REST) for a style.</p>
<pre>
{
  "weights": [
    { "class_code": "A", "weight_pct": 50 },
    { "class_code": "B", "weight_pct": 30 },
    { "class_code": "C", "weight_pct": 20 }
  ]
}
</pre>
<p>Validation:</p>
<ul>
<li>Each weight 0–100</li>
<li>Total must equal 100</li>
</ul>
</div>

<div class="endpoint">
<h3>GET /v1/styles/{style_id}/playback-profile</h3>
<p>
Integration-ready payload for the playback engine. Provides:
</p>
<ul>
  <li><code>mode</code>: <code>LEGACY</code> vs <code>CLASS_WEIGHTED</code></li>
  <li>Class weights for A/B/C</li>
  <li>Pool counts for A/B/C/UNCATEGORIZED/REST</li>
  <li>Optional track ids (debug only)</li>
</ul>

<h4>Query Params</h4>
<ul>
  <li><code>include_track_ids=true</code> (optional; default false)</li>
</ul>

<h4>Response</h4>
<pre>
{
  "data": {
    "style_id": "uuid",
    "mode": "LEGACY",
    "updated_at": "2026-02-20T18:00:00Z",
    "weights": { "A": 50, "B": 30, "C": 20 },
    "pools": {
      "A": { "count": 120 },
      "B": { "count": 80 },
      "C": { "count": 40 },
      "UNCATEGORIZED": { "count": 12 },
      "REST": { "count": 7 }
    }
  }
}
</pre>

<h4>Mode Rules</h4>
<ul>
  <li><code>LEGACY</code> when there are no A/B/C assigned tracks (100% uncategorized/rest) or A/B/C weights sum to 0</li>
  <li><code>CLASS_WEIGHTED</code> otherwise</li>
</ul>

<p>
<strong>Playback semantics:</strong> REST tracks are explicitly not played. Uncategorized tracks exist in the style but have no assignment.
</p>
</div>

</div>

<div class="section">
<h2>Error Format</h2>
<pre>
{
  "error": {
    "message": "Unauthorized",
    "status": 401
  }
}
</pre>
</div>

</body>
</html>
